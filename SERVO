#include <xc.h>

// -----------------------------------------
// 1. Crystal Frequency: 4 MHz
// -----------------------------------------
#define _XTAL_FREQ 4000000UL   

// -----------------------------------------
// 2. CONFIG: FOSC = XT for 4 MHz
// -----------------------------------------
#pragma config FOSC = XT
#pragma config WDTE = OFF
#pragma config PWRTE = ON
#pragma config BOREN = ON
#pragma config LVP = OFF
#pragma config CPD = OFF
#pragma config WRT = OFF
#pragma config CP = OFF

// Pin Definitions
#define SERVO_PIN  PORTCbits.RC2
#define SERVO_TRIS TRISCbits.TRISC2

// -----------------------------------------
// Custom delay helper (for 4MHz precision)
// -----------------------------------------
void delay_us_custom(unsigned int us)
{
    while(us >= 10)
    {
        __delay_us(10);
        us -= 10;
    }
    while(us > 0)
    {
        __delay_us(1);
        us--;
    }
}

// -----------------------------------------
// Generates a SINGLE 20ms frame
// -----------------------------------------
void generate_pulse(unsigned int angle)
{
    unsigned int pulse_width;
    
    // Calculate pulse (500us to 2500us)
    pulse_width = 500 + (angle * 2000UL) / 180UL;

    SERVO_PIN = 1;          // Pin HIGH
    delay_us_custom(pulse_width);

    SERVO_PIN = 0;          // Pin LOW
    // Complete the 20ms (20000us) frame
    delay_us_custom(20000 - pulse_width);
}

// -----------------------------------------
// Helper: Holds the servo in place for 3 Seconds
// -----------------------------------------
void hold_for_3_seconds(unsigned int angle)
{
    // A standard servo frame is 20ms.
    // 3000ms / 20ms = 150 frames.
    // We must keep sending pulses so the servo has torque.
    
    int frames = 150; 
    while(frames > 0)
    {
        generate_pulse(angle);
        frames--;
    }
}

// -----------------------------------------
// MAIN LOGIC
// -----------------------------------------
void Start_Servo_Sweep(void)
{
    // Configure Pin
    SERVO_TRIS = 0; // Output
    SERVO_PIN = 0;  // Low

    unsigned int angle = 0;
    int step = 1;

    while(1)
    {
        // 1. Send the movement pulse
        generate_pulse(angle);

        // 2. Check if we reached a limit
        if(angle == 180)
        {
            // Reached 180 -> HOLD for 3 sec
            hold_for_3_seconds(180);
            step = -1; // Switch direction down
        }
        else if(angle == 0)
        {
            // Reached 0 -> HOLD for 3 sec
            hold_for_3_seconds(0);
            step = 1;  // Switch direction up
        }

        // 3. Move to next angle
        angle += step;
    }
}

// -----------------------------------------
// Main
// -----------------------------------------
void main(void)
{
    Start_Servo_Sweep();
}
