#ifndef SERVO_H
#define SERVO_H

#include <xc.h>

#define _XTAL_FREQ 4000000UL
#define DOOR RB5

void delay_us_variable(unsigned int us)
{
    while(us > 0)
    {
        __asm("NOP");
        __asm("NOP");
        us--;
    }
}

void servo_pulse(unsigned char angle)
{
    unsigned int pulse_width;
    unsigned int remaining_us;
    unsigned char ms_delay;
   
    if(angle > 180) angle = 180;
   
    pulse_width = 1000 + (((unsigned int)angle * 111) / 20);
   
    if(pulse_width < 1000) pulse_width = 1000;
    if(pulse_width > 2000) pulse_width = 2000;
   
    DOOR = 1;
   
    if(pulse_width >= 1000)
    {
        __delay_us(500);
        __delay_us(500);
       
        remaining_us = pulse_width - 1000;
        if(remaining_us > 0)
        {
            delay_us_variable(remaining_us);
        }
    }
   
    DOOR = 0;
   
    remaining_us = 20000 - pulse_width;
    ms_delay = remaining_us / 1000;
    remaining_us = remaining_us % 1000;
   
    while(ms_delay > 0)
    {
        __delay_ms(1);
        ms_delay--;
    }
   
    if(remaining_us > 0)
    {
        delay_us_variable(remaining_us);
    }
}

void servo_set_angle(unsigned char angle)
{
    for(unsigned char i = 0; i < 30; i++)
    {
        servo_pulse(angle);
        CLRWDT();
    }
}

void servo_rotate_smooth(unsigned char start_angle, unsigned char end_angle, unsigned char step_delay_ms)
{
    unsigned char angle;
    unsigned char delay_count;
   
    if(start_angle < end_angle)
    {
        for(angle = start_angle; angle <= end_angle; angle += 5)
        {
            servo_pulse(angle);
           
            for(delay_count = 0; delay_count < step_delay_ms; delay_count++)
            {
                __delay_ms(1);
            }
            CLRWDT();
        }
    }
    else
    {
        for(angle = start_angle; angle >= end_angle; angle -= 5)
        {
            servo_pulse(angle);
           
            for(delay_count = 0; delay_count < step_delay_ms; delay_count++)
            {
                __delay_ms(1);
            }
            CLRWDT();
           
            if(angle < 5) break;
        }
    }
   
    servo_set_angle(end_angle);
}

void open_door(void)
{
    LCD_CMD(0x01);
    sendString("OPENING DOOR...");
    __delay_ms(500);
   
    servo_rotate_smooth(0, 180, 20);
    CLRWDT();
   
    LCD_CMD(0x01);
    sendString("DOOR OPEN");
    LCD_CMD(0xC0);
    sendString("CLOSING IN 5 SEC");
   
    for(unsigned char i = 0; i < 5; i++)
    {
        __delay_ms(1000);
        CLRWDT();
    }
   
    LCD_CMD(0x01);
    sendString("CLOSING DOOR...");
    __delay_ms(500);
   
    servo_rotate_smooth(180, 0, 20);
    CLRWDT();
   
    DOOR = 0;
   
    LCD_CMD(0x01);
    sendString("DOOR CLOSED");
    __delay_ms(1000);
}

void close_door_fast(void)
{
    servo_set_angle(0);
    DOOR = 0;
}

#endif
